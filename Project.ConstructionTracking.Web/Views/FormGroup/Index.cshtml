@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_LayoutSite.cshtml";
    var projectId = ViewBag.ProjectId;
    var projectName = ViewBag.ProjectName;
    var FormID = ViewBag.FormID;
    var UnitFormID = ViewBag.UnitFormID;
    var UnitFormName = ViewBag.UnitFormName;
    var unitId = ViewBag.unitId;
    var UnitCode = ViewBag.UnitCode;
    var UnitStatusName = ViewBag.UnitStatusName;
    var FormGroupDetail = ViewBag.FormGroupDetail;
    var grade = FormGroupDetail?.Grade;
    var PE_ActionType = FormGroupDetail?.PE_ActionType;
    var PE_StatusID = FormGroupDetail?.PE_StatusID;
    var PM_ActionType = FormGroupDetail?.PM_ActionType;
    var PM_StatusID = FormGroupDetail?.PM_StatusID;
    var PJM_ActionType = FormGroupDetail?.PJM_ActionType;
    var PJM_StatusID = FormGroupDetail?.PJM_StatusID;
    var FilePath = FormGroupDetail?.FilePath;

    var ListVender = ViewBag.ListVender;
    
}
@model List<Project.ConstructionTracking.Web.Models.FormGroupModel>
<style>

    .status-dot {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
        border: none;
        outline: none;
        font-size: 18px;
    }

    .card {
        border: none;
        border-radius: 10px;
    }

    .c-details span {
        font-weight: 300;
        font-size: 13px
    }

    .badge span {
        background-color: #fffbec;
        width: 60px;
        height: 25px;
        padding-bottom: 3px;
        border-radius: 5px;
        display: flex;
        color: #fed85d;
        justify-content: center;
        align-items: center
    }

    #icon {
        width: 50px;
        height: 50px;
        background-color: #eee;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 25px
    }

    .progress {
        height: 10px;
        border-radius: 10px
    }

    .progress div {
        background-color: red
    }

    .text1 {
        font-size: 14px;
        font-weight: 600
    }

    .text2 {
        color: green
    }

    .text3 {
        color: red
    }

    .signature_box {
        border: 1px solid black; /* Add a black border to the signature pad */
    }

    #modal-sign .modal-content .modal-body,
    #modal-sign-mech .modal-content .modal-body {
        display: -webkit-box;
        display: -ms-flexbox;
        display: block;
        -webkit-box-pack: center;
        -ms-flex-pack: center;
        justify-content: center;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
        width: 100%;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        margin: 0;
        padding: 16px 16px;
    }

     .autocomplete-items {
      position: absolute;
      border: 1px solid #d4d4d4;
      border-bottom: none;
      border-top: none;
      z-index: 9999; /* Ensure it appears on top */
      background-color: #fff;
      max-height: 200px;
      overflow-y: auto;
      left: 0; /* Aligns with the input */
      right: 0; /* Aligns with the input */
    }

    .autocomplete-items div {
      padding: 10px;
      cursor: pointer;
      background-color: #fff;
      border-bottom: 1px solid #d4d4d4;
    }

    .autocomplete-items div:hover {
      background-color: #e9e9e9;
    }

    .autocomplete-active {
      background-color: DodgerBlue !important;
      color: #ffffff;
    }

            .image-preview {
            display: none;
            width: 100%;
            height: auto;
            margin-bottom: 15px;
            border-radius: 10px;
        }
        .image-upload-input {
            display: none;
        }

</style>

<div class="page-wrapper">
    <!-- Page header -->
    <div class="page-header d-print-none">
        <div class="card bg-primary text-primary-fg">
            <div class="card-stamp">
                <div class="card-stamp-icon bg-white text-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-home-heart">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M21 12l-9 -9l-9 9h2v7a2 2 0 0 0 2 2h6" />
                        <path d="M9 21v-6a2 2 0 0 1 2 -2h2c.39 0 .754 .112 1.061 .304" />
                        <path d="M19 21.5l2.518 -2.58a1.74 1.74 0 0 0 0 -2.413a1.627 1.627 0 0 0 -2.346 0l-.168 .172l-.168 -.172a1.627 1.627 0 0 0 -2.346 0a1.74 1.74 0 0 0 0 2.412l2.51 2.59z" />
                    </svg>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div class="d-flex flex-row align-items-baseline">
                        <form asp-controller="Unitlist" asp-action="GoToByRole" method="post">
                            <input type="hidden" name="projectId" value="@projectId" />
                            <input type="hidden" name="projectName" value="@projectName" />
                            <input type="hidden" name="unitId" value="@unitId" />
                            <input type="hidden" name="UnitCode" value="@UnitCode" />
                            <input type="hidden" name="UnitStatusName" value="@UnitStatusName" />
                            <button class="status-dot bg-transparent">
                                <i class="fa-solid fa-chevron-left fa-xl" style="color: #f7f7f7;"></i>
                            </button>
                        </form>
                    </div>
                    <div class="d-block d-sm-flex align-items-baseline custom-heading">
                        <h3 class="mb-0 header-text"> @UnitFormName ( Unit : @UnitCode )</h3>
                        <div class="text-muted">
                            <h5 class="text-yellow d-block d-sm-inline ms-sm-2 mb-0">@projectName (สถานะ : @UnitStatusName)</h5>
                        </div>
                    </div>
                    <div class="align-items-right">

                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Page body -->
    <div class="page-body">
        <div class="container mt-1 mb-2">
            <div class="row">
                @foreach (var item in Model)
                {
                    <div class="col-md-4">
                        <div class="card card-link card-link-pop p-3 mb-2">
                            <div class="d-flex justify-content-between">
                                <div class="d-flex flex-row align-items-center">
                                    <form asp-controller="FormGroup" asp-action="GoToFormChecklist" method="post">
                                        <input type="hidden" id="projectId" name="projectId" value="@projectId" />
                                        <input type="hidden" id="projectName" name="projectName" value="@projectName" />
                                        <input type="hidden" id="FormID" name="FormID" value="@FormID" />
                                        <input type="hidden" id="UnitFormID" name="UnitFormID" value="@UnitFormID" />
                                        <input type="hidden" name="UnitFormName" value="@UnitFormName" />
                                        <input type="hidden" id="unitId" name="unitId" value="@unitId" />
                                        <input type="hidden" name="UnitCode" value="@UnitCode" />
                                        <input type="hidden" name="UnitStatusName" value="@UnitStatusName" />
                                        <input type="hidden" name="GroupName" value="@item.GroupName" />
                                        <input type="hidden" name="GroupID" value="@item.GroupID" />
                                        <button class="status-dot bg-@item.StatusUse @(item.StatusUse == "danger" || item.StatusUse == "warning" ? "status-dot-animated" : "")">
                                            @if (item.StatusUse == "success")
                                            {
                                                <i class="fa-regular fa-circle-check"></i>
                                            }
                                            else if (item.StatusUse == "danger")
                                            {
                                                <i class="fa-regular fa-circle-xmark"></i>
                                            }
                                            else if (item.StatusUse == "warning")
                                            {
                                                <i class="fa-solid fa-file-pen"></i>
                                            }
                                            else if (item.StatusUse == "secondary")
                                            {
                                                <i class="fa-solid fa-magnifying-glass"></i>
                                            }
                                        </button>
                                    </form>
                                    <div class="ms-2 c-details">
                                        <h3 class="mb-0">@item.GroupName</h3>
                                    </div>
                                </div>
                                @if (item.LockStatusID != 0)
                                {
                                    @if (item.LockStatusID == 1)
                                    {
                                         <form action="@Url.Action("index","FormCheckList")" method="post">
                                            <button class="status-dot bg-primary">
                                                <span class="status-text"><i class="fa-solid fa-lock"></i></span>
                                            </button>
                                        </form>                                   
                                    }
                                    else if (item.LockStatusID == 4)
                                    {
                                        <form action="@Url.Action("index","FormCheckList")" method="post">
                                            <button class="status-dot bg-success">
                                                <span class="status-text"><i class="fa-solid fa-lock"></i></span>
                                            </button>
                                        </form>
                                    }
                                    else if (item.LockStatusID == 6)
                                    {
                                        <form action="@Url.Action("index","FormCheckList")" method="post">
                                            <button class="status-dot bg-primary">
                                                <span class="status-text"><i class="fa-solid fa-lock-open"></i></span>
                                            </button>
                                        </form>
                                    }
                                    else if (item.LockStatusID == 7)
                                    {
                                        <form action="@Url.Action("index","FormCheckList")" method="post">
                                            <button class="status-dot bg-danger">
                                                <span class="status-text"><i class="fa-solid fa-lock-open"></i></span>
                                            </button>
                                        </form>
                                    }
                                    else if (item.LockStatusID == 8)
                                    {
                                        <form action="@Url.Action("index","FormCheckList")" method="post">
                                            <button class="status-dot bg-success">
                                                <span class="status-text"><i class="fa-solid fa-lock-open"></i></span>
                                            </button>
                                        </form>
                                    }
                                    else if (item.LockStatusID == 9)
                                    {
                                        <form action="@Url.Action("index","FormCheckList")" method="post">
                                            <button class="status-dot bg-danger">
                                                <span class="status-text"><i class="fa-solid fa-lock-open"></i></span>
                                            </button>
                                        </form>
                                    }
                                }
                                else  
                                {
                        
                                }
                            </div>
                            <div class="mt-3">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><span class="text1">รายการทั้งหมด @item.Cnt_CheckList_All </span></li>
                                    <li class="breadcrumb-item" aria-current="page"><span class="text2">ตรวจแล้ว @item.Cnt_CheckList_Unit </span></li>
                                    <li class="breadcrumb-item" aria-current="page"><span class="text3">ไม่ผ่าน @item.Cnt_CheckList_NotPass</span></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
        <div class="container mt-1 mb-2">
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div class="d-flex flex-row align-items-center">
                                    <div id="icon"> <i class="fa-solid fa-building-user"></i></div>
                                    <div class="ms-2 c-details">
                                        <h3 class="mb-0">ประเมิณคุณภาพการทำงานในงวด</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-center">
                                <label class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="radios-inline" value="A" onclick="toggleRadio(this)" @(grade == "A" ? "checked" : "")>
                                    <span class="form-check-label">A</span>
                                </label>
                                <label class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="radios-inline" value="B" onclick="toggleRadio(this)" @(grade == "B" ? "checked" : "")>
                                    <span class="form-check-label">B</span>
                                </label>
                                <label class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="radios-inline" value="C" onclick="toggleRadio(this)" @(grade == "C" ? "checked" : "")>
                                    <span class="form-check-label">C</span>
                                </label>
                                <label class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="radios-inline" value="D" onclick="toggleRadio(this)" @(grade == "D" ? "checked" : "")>
                                    <span class="form-check-label">D</span>
                                </label>
                            </div>
                            <div class="mt-3">
                                <label class="form-label">วิศกรผู้ควบคุมงาน</label>
                                <input type="text" class="form-control" name="example-disabled-input" placeholder="Disabled..." value="นาย สมชาย ใจดี" disabled>
                            </div>
                            @if (@PE_ActionType == "submit")
                            {
                                <div class="mt-3">
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal1">
                                        <img src="~/@FilePath" alt="Gallery Image 1" class="rounded">
                                    </a>
                                </div>
                            }
                        </div>
                        <!-- Card footer -->
                        <div class="card-footer">
                            <div class="d-flex">
                                @if (PE_ActionType == "submit")
                                {
                                    if (PM_StatusID == null)
                                    {
                                        <label class="form-label">รอคำอนุมัติจาก PM</label>
                                    }
                                    else if (PM_StatusID == 4)
                                    {
                                        <label class="form-label">PM อนุมัติ</label>
                                    }
                                    else if (PM_StatusID == 5)
                                    {
                                        <label class="form-label text-danger">PM ไม่อนุมัติ</label>
                                        <button class="btn btn-secondary" onclick="saveData()">Save</button>
                                        <button type="button" class="btn btn-primary ms-auto" data-bs-toggle="modal" id="btn-vendor">Submit</button>
                                    }
                                    else if (PM_StatusID == 6)
                                    {
                                        <label class="form-label">PM ส่งไปให้ PJM ตัดสินใจ</label>

                                        @if (PJM_StatusID == 7)
                                        {
                                            <label class="form-label">PJM อนุมัติ</label>
                                        }
                                        else if (PJM_StatusID == 8)
                                        {
                                            <label class="form-label text-danger">PJM ไม่อนุมัติ</label>
                                            <button class="btn btn-secondary" onclick="saveData()">Save</button>
                                            <button type="button" class="btn btn-primary ms-auto" data-bs-toggle="modal" id="btn-vendor">Submit</button>
                                        }
                                    }
                                }
                                else
                                {
                                    <button class="btn btn-secondary" onclick="saveData()">Save</button>
                                    <button type="button" class="btn btn-primary ms-auto" data-bs-toggle="modal" id="btn-vendor">Submit</button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    <div id="modal-sign" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id=""><i class="fas fa-signature"></i> ผู้รับเหมาลงนาม</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="sign-body modal-body">
                    <div class="row">
                        <div class="col-sm-12 mt-1 mb-2" style="position: relative;">
                            <label for="ddlList" class="form-label">เลือกผู้รับเหมา</label>
                            <input id="ddlList" name="unitStatusId" class="form-control" autocomplete="off">
                            <div id="autocomplete-list" class="autocomplete-items"></div>
                            <input type="hidden" id="selectedVendorValue" name="selectedVendorValue">
                        </div>
                        <div class="col-sm-12 mt-1 mb-2">
                            <label for="signature-pad" class="form-label">ลงลายเซ็นผู้รับเหมา</label>
                            <div id="signature-pad" class="signature-pad" style="justify-content:center;align-items:center;display:flex;">
                                <div class="signature-pad--body" style="width:350px;height:260px">
                                    <canvas></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="col-md-12 col-sm-12 col-xs-12 text-center">
                        <button type="button" class="clear btn btn-default"><i class="fas fa-reply"></i> เคลียร์</button>
                        <button id="btn-save-sign" type="button" class="permission btn btn-success"><i class="fas fa-check"></i> บันทึก</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal modal-blur fade" id="imageModal1" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body p-0">
                    <img src="~/@FilePath"  class="img-fluid" alt="Gallery Image 1">
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <link href="~/lib/core-ui/signature-pad-master/css/signature-pad.css" />
    <script src="~/lib/core-ui/signature-pad-master/js/signature_pad.umd.js"></script>
    <script src="~/js/pages/unitEquipment.js?ver=@DateTime.Now.Ticks.ToString()"></script>
    <script src="https://kit.fontawesome.com/21fea36ed8.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(() => {
            unitEquipment.init();

            var availableVendors = [
            @foreach (var item in ListVender)
                {
                    @Html.Raw($"{{ text: \"{item.Text}\", value: \"{item.Value}\" }},")
                }
            ];

            function autocomplete(input, array) {
                var currentFocus;
                input.addEventListener("input", function (e) {
                    var a, b, i, val = this.value;
                    closeAllLists();
                    if (!val) { return false; }
                    currentFocus = -1;
                    a = document.createElement("DIV");
                    a.setAttribute("id", this.id + "autocomplete-list");
                    a.setAttribute("class", "autocomplete-items");
                    this.parentNode.appendChild(a);
                    for (i = 0; i < array.length; i++) {
                        if (array[i].text.toUpperCase().indexOf(val.toUpperCase()) !== -1) {
                            b = document.createElement("DIV");
                            var startIndex = array[i].text.toUpperCase().indexOf(val.toUpperCase());
                            var endIndex = startIndex + val.length;
                            b.innerHTML = array[i].text.substr(0, startIndex) + "<strong>" + array[i].text.substr(startIndex, val.length) + "</strong>" + array[i].text.substr(endIndex);
                            b.innerHTML += "<input type='hidden' value='" + array[i].text + "' data-value='" + array[i].value + "'>";
                            b.addEventListener("click", function (e) {
                                input.value = this.getElementsByTagName("input")[0].value;
                                document.getElementById('selectedVendorValue').value = this.getElementsByTagName("input")[0].getAttribute('data-value');
                                closeAllLists();
                            });
                            a.appendChild(b);
                        }
                    }
                });

                input.addEventListener("keydown", function (e) {
                    var x = document.getElementById(this.id + "autocomplete-list");
                    if (x) x = x.getElementsByTagName("div");
                    if (e.keyCode == 40) {
                        currentFocus++;
                        addActive(x);
                    } else if (e.keyCode == 38) {
                        currentFocus--;
                        addActive(x);
                    } else if (e.keyCode == 13) {
                        e.preventDefault();
                        if (currentFocus > -1) {
                            if (x) x[currentFocus].click();
                        }
                    }
                });

                function addActive(x) {
                    if (!x) return false;
                    removeActive(x);
                    if (currentFocus >= x.length) currentFocus = 0;
                    if (currentFocus < 0) currentFocus = (x.length - 1);
                    x[currentFocus].classList.add("autocomplete-active");
                }

                function removeActive(x) {
                    for (var i = 0; i < x.length; i++) {
                        x[i].classList.remove("autocomplete-active");
                    }
                }

                function closeAllLists(elmnt) {
                    var x = document.getElementsByClassName("autocomplete-items");
                    for (var i = 0; i < x.length; i++) {
                        if (elmnt != x[i] && elmnt != input) {
                            x[i].parentNode.removeChild(x[i]);
                        }
                    }
                }

                document.addEventListener("click", function (e) {
                    closeAllLists(e.target);
                });
            }

            autocomplete(document.getElementById("ddlList"), availableVendors);
        });
    </script>


}
